<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>DORO射撃ゲーム（完全統合版：ランキング対応）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- p5.js & p5.sound -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/addons/p5.sound.min.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
  body { margin:0; background:#222; color:#fff; font-family:sans-serif; }
  #hint { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.4); padding: 8px 12px; font-size: 14px; border-radius: 6px; z-index:100; }
  .p5dom { z-index:200; }
  .btn { background:#3aa; color:#fff; padding:6px 10px; border-radius:6px; cursor:pointer; border:none; }
</style>
</head>
<body>
<div id="hint">Hold mouse to shoot / Auto reload</div>

<script>
// Firebase
const firebaseConfig = { databaseURL: "https://doro-e35b4-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---- Game Variables ----
const tableTopLeftX=230,tableTopRightX=570,tableBottomLeftX=80,tableBottomRightX=720;
const tableTopY=140,tableBottomY=440,laneCount=5;
let doroRemaining=100,maxAmmo=30,ammo=30,fireInterval=200,lastFireTime=0;
let reloadTime=500,isReloading=false;
let crosshairSpread=0,crosshairTargetSpread=0;
let longShootSound,reloadSound,isLongSoundPlaying=false;
let startTime=0,clearTime=0,gameCleared=false;
let screenState="start";
let lanes=[],targets=[],bullets=[],targetImg=null;

const BASE_SCORE=10000;
let missedShots=0,lastScore=0,highScore=0;
const HIGH_KEY="doro_highscore";

let playerName="";
let rankingList=[];

// UI elements
let nameInput,startButton,rankingButton;

// preload
function preload(){
  longShootSound=loadSound("sound/shot.mp3");
  reloadSound=loadSound("sound/reload.mp3");
  targetImg=loadImage("images/doro-removebg-preview.png");
}

function setup(){
  createCanvas(900,600);

  // local highscore
  const stored=localStorage.getItem(HIGH_KEY);
  highScore = stored ? parseInt(stored,10)||0 : 0;

  // ---- UI Elements ----
  nameInput = createInput("");
  nameInput.attribute("placeholder","プレイヤー名");
  nameInput.position(width/2-180,height/2-22);
  nameInput.size(220,24);
  nameInput.addClass("p5dom");

  // 入力リアルタイム取得（disabled 制御はしない）
  nameInput.input(()=>{
    playerName = nameInput.value().trim();
  });

  startButton = createButton("スタート");
  startButton.addClass("btn p5dom");
  startButton.position(width/2+10,height/2-22);

  // ★ 常に押せる。名前が空なら警告を出す方式 ★
  startButton.mousePressed(()=>{
    playerName = nameInput.value().trim();

    if(playerName.length === 0){
      alert("プレイヤー名を入力してください");
      return;
    }

    screenState="game";
    doroRemaining=100;
    initScene();
  });

  rankingButton = createButton("ランキング");
  rankingButton.addClass("btn p5dom");
  rankingButton.position(width/2+110,height/2-22);
  rankingButton.mousePressed(()=>{ fetchRanking(); });
}

function draw(){
  background(36,42,64);

  if(screenState==="start"){
    cursor();
    nameInput.show(); startButton.show(); rankingButton.show();
    drawStartScreen();
  } else {
    nameInput.hide(); startButton.hide(); rankingButton.hide();
  }

  if(screenState==="instructions"){ cursor(); drawInstructionsScreen(); }
  else if(screenState==="game"){ noCursor(); drawGame(); }
  else if(screenState==="clear"){ cursor(); drawClearScreen(); }
  else if(screenState==="ranking"){ cursor(); drawRankingScreen(); }
}

function drawStartScreen(){
  push();
  fill(255); textSize(32);
  textAlign(LEFT);
  text("DOROゲーム", 24,64);

  fill(200); textSize(14);
  text("プレイヤー名を入力してください", 24, 94);

  fill(255); textSize(14);
  text(`ローカルハイスコア: ${highScore}`,24,height-30);
  pop();
}

function drawInstructionsScreen(){
  push(); fill(255); textAlign(CENTER);
  textSize(36); text("プレイ方法", width/2, height/2-60);
  textSize(24); text("DOROを素早く倒したら勝ち！", width/2,height/2);
  textSize(18); text("クリックで戻る", width/2,height/2+60);
  pop();
}

function drawGame(){
  drawTable();
  updateTargets(); drawTargets();
  updateBullets(); drawBullets();
  drawCrosshair();
  handleShooting();
  drawUI();

  if(!gameCleared && doroRemaining<=0){
    clearTime=(millis()-startTime)/1000;

    try{ longShootSound.stop(); }catch(e){}
    isLongSoundPlaying=false;

    gameCleared=true;
    computeScoreAndSave();

    if(playerName.length>0){
      sendScoreToFirebase({
        name:playerName,
        score:lastScore,
        time:Number(clearTime.toFixed(3)),
        miss:missedShots,
        createdAt:Date.now()
      });
    }

    screenState="clear";
  }
}

function initScene(){
  lanes=[]; targets=[]; bullets=[];
  ammo=maxAmmo; isReloading=false;
  lastFireTime=0; gameCleared=false;
  isLongSoundPlaying=false;
  missedShots=0; lastScore=0;

  let y=tableTopY+12;
  for(let i=0;i<laneCount;i++){
    const t=i/(laneCount-1);
    const gap=lerp(20,95,t);
    const size=lerp(34,78,t);
    const speed=lerp(1.4,3.6,t);

    const leftX=map(y,tableTopY,tableBottomY,tableTopLeftX,tableBottomLeftX);
    const rightX=map(y,tableTopY,tableBottomY,tableTopRightX,tableBottomRightX);

    lanes.push({y,leftX,rightX,size,speed});

    const amp=lerp(22,30,t),phase=random(TWO_PI);

    for(let j=0;j<Math.ceil(doroRemaining/laneCount);j++){
      const xPos=random(leftX+20, rightX-20);
      targets.push({
        lane:i, baseX:xPos,x:xPos,
        currentY:y,baseY:y,
        size,dir:random([-1,1]),
        speed,alive:true,
        bounceAmp:amp,bouncePhase:phase,
        bounceFreq:lerp(0.06,0.12,random()),
        vx:0,vy:0
      });
    }
    y+=gap;
  }

  startTime=millis();
}

function updateTargets(){
  for(let t of targets){
    if(!t.alive) continue;

    const L=lanes[t.lane];
    const d = dist(mouseX,mouseY,t.x,t.baseY);

    if(d<200){
      const ang=atan2(t.baseY-mouseY,t.x-mouseX);
      t.vx+=cos(ang)*0.35; t.vy+=sin(ang)*0.12;
    } else t.vx+=t.speed*t.dir*0.06;

    t.vx+=random(-0.04,0.04);
    t.vx=constrain(t.vx,-4.5,4.5);
    t.vy=constrain(t.vy,-1.2,1.2);

    t.x+=t.vx;
    t.baseY+=t.vy;
    t.baseY=lerp(t.baseY,L.y,0.04);

    const Lb=L.leftX+12, Rb=L.rightX-12;
    if(t.x<Lb) t.x=Rb-2;
    if(t.x>Rb) t.x=Lb+2;

    const bounce = sin(frameCount*t.bounceFreq+t.bouncePhase)*t.bounceAmp;
    t.currentY = t.baseY - Math.abs(bounce);
  }
}

function drawTargets(){
  imageMode(CENTER);
  for(let t of targets){
    if(!t.alive) continue;
    push();
    translate(t.x,t.currentY);
    if(t.vx>0) scale(-1,1);
    image(targetImg,0,0,t.size,t.size);
    pop();
  }
}

function fireBullet(){
  const ox=width/2, oy=height-10;
  const dx=mouseX-ox, dy=mouseY-oy;
  const d=sqrt(dx*dx+dy*dy)||1;

  bullets.push({
    x:ox,y:oy,
    vx:(dx/d)*20, vy:(dy/d)*20
  });
}

function updateBullets(){
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];
    b.x+=b.vx; b.y+=b.vy;

    if(b.x<-50||b.x>width+50||b.y<-50||b.y>height+50){
      missedShots++;
      bullets.splice(i,1);
      continue;
    }

    for(let t of targets){
      if(!t.alive) continue;
      if(dist(b.x,b.y,t.x,t.currentY)<=t.size*0.5){
        t.alive=false;
        bullets.splice(i,1);
        if(doroRemaining>0) doroRemaining--;
        break;
      }
    }
  }
}

function drawBullets(){
  fill(255,230,130);
  noStroke();
  for(let b of bullets) ellipse(b.x,b.y,12);
}

function drawCrosshair(){
  crosshairSpread=lerp(crosshairSpread,crosshairTargetSpread,0.15);
  crosshairTargetSpread*=0.85;

  stroke(255); strokeWeight(2);
  const cx=mouseX,cy=mouseY;

  line(cx,cy-20-crosshairSpread,cx,cy-5);
  line(cx,cy+5,cx,cy+20+crosshairSpread);
  line(cx-20-crosshairSpread,cy,cx-5,cy);
  line(cx+5,cy,cx+20+crosshairSpread,cy);
}

function drawUI(){
  fill(255); textSize(16);
  text(`DORO残り ${doroRemaining}匹`,10,50);

  const barX=mouseX-70,barY=mouseY-20,barW=60,barH=10;
  let barColor=color(255);
  if(isReloading||ammo<=0) barColor=color(150);
  else if(ammo<=maxAmmo/2) barColor=color(255,0,0);

  noStroke(); fill(80);
  rect(barX,barY,barW,barH,4);
  fill(barColor);
  rect(barX,barY,(ammo/maxAmmo)*barW,barH,4);

  fill(barColor); textSize(14);
  text(String(ammo).padStart(3,"0"),barX,barY+barH+14);

  fill(255);
  text(`外した弾: ${missedShots}`,10,70);
}

function handleShooting(){
  if(!mouseIsPressed||ammo<=0){
    if(isLongSoundPlaying){
      try{ longShootSound.stop(); }catch(e){}
      isLongSoundPlaying=false;
    }
    if(!isReloading&&ammo<maxAmmo){
      isReloading=true;
      try{ reloadSound.play(); }catch(e){}
      setTimeout(()=>{ ammo=maxAmmo; isReloading=false; }, reloadTime);
    }
    return;
  }

  if(!isLongSoundPlaying){
    try{ longShootSound.play(); }catch(e){}
    isLongSoundPlaying=true;
  }

  const now=millis();
  if(now-lastFireTime>fireInterval&&!isReloading){
    fireBullet();
    lastFireTime=now;
    ammo--;
    crosshairTargetSpread=12;
  }
}

function computeScoreAndSave(){
  const timePenalty=Math.floor(clearTime*50);
  const missPenalty=missedShots*20;

  lastScore=Math.max(0,BASE_SCORE-timePenalty-missPenalty);

  if(lastScore>highScore){
    highScore=lastScore;
    localStorage.setItem(HIGH_KEY,String(highScore));
  }
}

function drawClearScreen(){
  push();
  fill(255);
  textAlign(CENTER);
  textSize(56);
  text("CLEAR!", width/2, height/2 - 120);

  textSize(20);
  text(`クリア時間: ${clearTime.toFixed(2)} 秒`, width/2, height/2 - 60);
  text(`外した弾: ${missedShots} 発`, width/2, height/2 - 30);

  const timePenalty=Math.floor(clearTime*50);
  const missPenalty=missedShots*20;

  textSize(18);
  text(`計算: ${BASE_SCORE} - (時間 ${Math.floor(clearTime)}s × 50) - (外し ${missedShots} × 20)`,
       width/2, height/2 + 10);

  textSize(36);
  text(`スコア: ${lastScore}`, width/2, height/2 + 60);

  textSize(18);
  text(`ハイスコア: ${highScore}`, width/2, height/2 + 100);

  fill(200,230,255);
  rectMode(CENTER);
  rect(width/2 - 120, height/2 + 150, 160, 44, 8);
  fill(20);
  text("リトライ", width/2 - 120, height/2 + 150);

  fill(200,230,255);
  rect(width/2 + 120, height/2 + 150, 160, 44, 8);
  fill(20);
  text("タイトルへ", width/2 + 120, height/2 + 150);
  pop();
}

function fetchRanking(){
  rankingList=[];
  screenState="ranking";

  db.ref("scores").orderByChild("score").limitToLast(10).once("value", snap=>{
    const d=snap.val();
    if(!d) return;
    rankingList = Object.keys(d).map(k=>({...d[k], key:k}));
    rankingList.sort((a,b)=>b.score-a.score);
  });
}

function drawRankingScreen(){
  fill(255);
  textAlign(CENTER);
  textSize(32);
  text("ランキング TOP10", width/2, 80);

  textSize(16);
  let y=130;

  for(let i=0;i<10;i++){
    if(i<rankingList.length){
      let r=rankingList[i];
      text(`${i+1}. ${r.name}  Score:${r.score}  Time:${r.time}s  Miss:${r.miss}`, width/2, y);
    } else {
      text(`${i+1}. ---`, width/2, y);
    }
    y+=30;
  }

  rectMode(CENTER);
  fill(200,230,255);
  rect(width/2, height-80, 160, 40, 8);
  fill(20);
  text("戻る", width/2, height-80);
}

function sendScoreToFirebase(payload){
  return db.ref("scores").push(payload);
}

function mousePressed(){
  if(screenState==="instructions"){
    screenState="start";
    return;
  }
  if(screenState==="clear"){
    const rx=width/2-120, ry=height/2+150;
    if(mouseX>rx-80 && mouseX<rx+80 && mouseY>ry-20 && mouseY<ry+20){
      doroRemaining=100;
      screenState="game";
      initScene();
      return;
    }

    const tx=width/2+120, ty=height/2+150;
    if(mouseX>tx-80 && mouseX<tx+80 && mouseY>ty-20 && mouseY<ty+20){
      screenState="start";
      return;
    }
  }

  if(screenState==="ranking"){
    const bx=width/2, by=height-80;
    if(mouseX>bx-80 && mouseX<bx+80 && mouseY>by-20 && mouseY<by+20){
      screenState="start";
    }
  }
}

function drawTable(){
  noStroke();
  fill(145,100,60);
  quad(
    tableTopLeftX,tableTopY,
    tableTopRightX,tableTopY,
    tableBottomRightX,tableBottomY,
    tableBottomLeftX,tableBottomY
  );
}
</script>
</body>
</html>

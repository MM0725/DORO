<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>DORO射的ゲーム（射撃＋リロード音）</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/addons/p5.sound.min.js"></script>

<style>
  html,body{
    height:100%;margin:0;background:#222;color:#fff;font-family:system-ui;
  }
</style>
</head>

<body>

<script>
// ======================================================
// 基本設定
// ======================================================
const tableTopLeftX  = 230;
const tableTopRightX = 570;
const tableBottomLeftX  = 80;
const tableBottomRightX = 720;
const tableTopY = 140;
const tableBottomY = 440;

let doroRemaining = 100;

let maxAmmo = 30;
let ammo = maxAmmo;
let fireInterval = 200;
let lastFireTime = 0;
let reloadTime = 500;
let isReloading = false;

// クロスヘア
let crosshairSpread = 0;
let crosshairTargetSpread = 0;

// 音
let shootSound;
let reloadSound;

// 状態
let screenState = "start";

let targets = [];
let bullets = [];
let targetImg;

// ======================================================
// setup
// ======================================================
function setup(){
  createCanvas(900, 600);

  targetImg = loadImage("images/doro-removebg-preview.png");

  shootSound  = loadSound("sound/IMG_9225.mp3");
  reloadSound = loadSound("sound/リロード.MP3");  // ←ファイルパスそのまま

  ammo = maxAmmo;
}

// ======================================================
// draw
// ======================================================
function draw(){
  background(36,42,64);

  if(screenState === "start"){
    drawStartScreen();
    cursor();
  }else if(screenState === "game"){
    noCursor();
    drawGame();
  }
}

// ======================================================
// スタート画面
// ======================================================
function drawStartScreen(){
  fill(255);
  textAlign(CENTER);
  textSize(48);
  text("DOROゲーム", width/2, height/2 - 60);

  fill(50,150,255);
  rectMode(CENTER);
  rect(width/2, height/2 + 20, 160, 50, 12);
  fill(255);
  textSize(24);
  text("スタート", width/2, height/2 + 20);
}

// ======================================================
// ゲーム開始初期化
// ======================================================
function initGame(){
  targets = [];
  bullets = [];
  ammo = maxAmmo;
  isReloading = false;
  lastFireTime = 0;

  // 5レーン×20体
  for(let i=0;i<5;i++){
    for(let j=0;j<20;j++){
      targets.push({
        x: random(200,700),
        y: 150 + i*55,
        size: 60,
        alive: true
      });
    }
  }
}

// ======================================================
// ゲーム描画
// ======================================================
function drawGame(){
  drawTargets();
  updateBullets();
  drawBullets();
  handleShooting();
  drawCrosshair();
  drawUI();
}

// ======================================================
// ターゲット描画
// ======================================================
function drawTargets(){
  imageMode(CENTER);

  for(let t of targets){
    if(!t.alive) continue;
    image(targetImg, t.x, t.y, t.size, t.size);
  }
}

// ======================================================
// 弾管理
// ======================================================
function fireBullet(){
  if(shootSound && shootSound.isLoaded()) shootSound.play();

  const ox = width/2;
  const oy = height - 8;
  const dx = mouseX - ox;
  const dy = mouseY - oy;
  const d = sqrt(dx*dx + dy*dy)||1;

  bullets.push({
    x: ox,
    y: oy,
    vx:(dx/d)*20,
    vy:(dy/d)*20
  });

  crosshairTargetSpread = 12;
}

function updateBullets(){
  for(let i=bullets.length-1;i>=0;i--){
    let b = bullets[i];
    b.x += b.vx;
    b.y += b.vy;

    for(let t of targets){
      if(!t.alive) continue;
      if(dist(b.x,b.y,t.x,t.y) < t.size/2){
        t.alive = false;
        doroRemaining--;
        bullets.splice(i,1);
        break;
      }
    }

    if(b.y < -20) bullets.splice(i,1);
  }
}

function drawBullets(){
  noStroke();
  fill(255,230,120);
  for(let b of bullets){
    ellipse(b.x,b.y,12);
  }
}

// ======================================================
// 射撃・リロード
// ======================================================
function handleShooting(){

  // 自動リロード
  if(!isReloading && ammo < maxAmmo){

    // ★リロード音（確実に鳴る）
    try{
      reloadSound.play();
    }catch(e){
      console.log("reload play error", e);
    }

    isReloading = true;

    setTimeout(()=>{
      ammo = maxAmmo;
      isReloading = false;
    }, reloadTime);
  }

  if(!mouseIsPressed) return;
  if(isReloading) return;
  if(ammo <= 0) return;

  const now = millis();
  if(now - lastFireTime > fireInterval){
    fireBullet();
    ammo--;
    lastFireTime = now;
  }
}

// ======================================================
// クロスヘア（広がるアニメ）
// ======================================================
function drawCrosshair(){
  crosshairSpread = lerp(crosshairSpread, crosshairTargetSpread, 0.2);
  crosshairTargetSpread *= 0.85;

  const cx = mouseX;
  const cy = mouseY;

  stroke(255);
  strokeWeight(2);

  line(cx, cy - 15 - crosshairSpread, cx, cy - 5);
  line(cx, cy + 5, cy, cy + 15 + crosshairSpread);

  line(cx - (15 + crosshairSpread), cy, cx - 5, cy);
  line(cx + 5, cy, cx + (15 + crosshairSpread), cy);
}

// ======================================================
// UI（残弾）
// ======================================================
function drawUI(){
  const barW = 60;
  const barH = 10;

  const bx = mouseX - 80;
  const by = mouseY - 40;

  noStroke();
  fill(80);
  rect(bx,by,barW,barH,4);

  let col = ammo <= maxAmmo/2 ? color(255,0,0) : color(255);
  if(isReloading) col = color(150);

  fill(col);
  rect(bx,by,(ammo/maxAmmo)*barW,barH,4);

  fill(col);
  textSize(16);
  text(String(ammo).padStart(3,"0"), bx, by + 22);
}

// ======================================================
// mousePressed
// ======================================================
function mousePressed(){
  if(getAudioContext().state !== "running"){
    getAudioContext().resume();
  }

  if(screenState==="start"){
    if(mouseX>width/2-80 && mouseX<width/2+80 &&
       mouseY>height/2 && mouseY<height/2+50){
      screenState="game";
      initGame();
    }
  }
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>DORO射撃ゲーム（スマホ最適化＋ランキング対応）</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

<!-- p5.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/addons/p5.sound.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
  body { margin:0; background:#222; color:#fff; font-family:sans-serif; overflow:hidden; }
  .p5dom { z-index:10; }
  .btn { background:#3aa; color:#fff; padding:6px 10px; border-radius:6px; border:none; cursor:pointer; }
</style>
</head>
<body>

<script>
// ================================
//  Firebase 設定
// ================================
const firebaseConfig = {
  databaseURL: "https://doro-e35b4-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================================
//  画面サイズに応じたスケール計算
// ================================
let W, H;
let scaleRate = 1;

// すべての描画はこの比率で調整
function updateScale() {
  W = windowWidth;
  H = windowHeight;

  // 基準 900×600
  scaleRate = min(W / 900, H / 600);
}

// ================================
//  ゲーム変数
// ================================
let doroRemaining = 100;
let maxAmmo = 30;
let ammo = 30;
let fireInterval = 200;
let lastFireTime = 0;
let reloadTime = 500;
let isReloading = false;

let crosshairSpread = 0;
let crosshairTargetSpread = 0;

let longShootSound, reloadSound;
let isLongSoundPlaying = false;

let startTime = 0;
let clearTime = 0;
let gameCleared = false;
let screenState = "start";

let lanes = [];
let targets = [];
let bullets = [];

let targetImg = null;

const BASE_SCORE = 10000;
let missedShots = 0;
let lastScore = 0;
let highScore = 0;

const HIGH_KEY = "doro_highscore";

// 名前入力＋ボタン
let nameInput, startButton, rankingButton;
let playerName = "";
let rankingList = [];

// ================================
//  preload
// ================================
function preload() {
  longShootSound = loadSound("sound/shot.mp3");
  reloadSound = loadSound("sound/reload.mp3");
  targetImg = loadImage("images/doro-removebg-preview.png");
}

// ================================
//  setup
// ================================
function setup() {
  updateScale();
  createCanvas(W, H);

  // ローカルハイスコア読込
  const stored = localStorage.getItem(HIGH_KEY);
  highScore = stored ? parseInt(stored, 10) || 0 : 0;

  // ▼ UI作成
  nameInput = createInput("");
  nameInput.attribute("placeholder", "プレイヤー名");
  nameInput.addClass("p5dom");

  startButton = createButton("スタート");
  startButton.addClass("btn p5dom");

  rankingButton = createButton("ランキング");
  rankingButton.addClass("btn p5dom");

  // ▼ ボタン動作
  startButton.mousePressed(() => {
    playerName = nameInput.value().trim();
    if (playerName === "") {
      alert("プレイヤー名を入力してください");
      return;
    }
    screenState = "game";
    initScene();
  });

  rankingButton.mousePressed(() => {
    fetchRanking();
  });

  adjustUI();
}

// スマホ回転対応
function windowResized() {
  updateScale();
  resizeCanvas(W, H);
  adjustUI();
}

// ================================
//  UI位置調整（スマホ最適化）
// ================================
function adjustUI() {
  if (!nameInput) return;

  if (screenState === "start") {
    const inputW = min(240, W * 0.6);
    nameInput.size(inputW, 26);

    nameInput.position(W / 2 - inputW / 2, H * 0.42);
    startButton.position(W / 2 - 70, H * 0.52);
    rankingButton.position(W / 2 + 10, H * 0.52);

    nameInput.show();
    startButton.show();
    rankingButton.show();
  } else {
    nameInput.hide();
    startButton.hide();
    rankingButton.hide();
  }
}
